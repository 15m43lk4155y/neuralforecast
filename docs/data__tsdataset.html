---

title: Default mask example and tests


keywords: fastai
sidebar: home_sidebar



nb_path: "nbs/data__tsdataset.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/data__tsdataset.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Time-Series-Dataset">Time Series Dataset<a class="anchor-link" href="#Time-Series-Dataset"> </a></h2><blockquote><p>Transforms pandas DataFrame into a TimeSeriesDataset for the Dataloder.</p>
</blockquote>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="TimeSeriesDataset" class="doc_header"><code>class</code> <code>TimeSeriesDataset</code><a href="https://github.com/Grupo-Abraxas/nixtla/tree/master/nixtla/data/tsdataset.py#L22" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>TimeSeriesDataset</code>(<strong>*<code>args</code></strong>, <strong>**<code>kwds</code></strong>) :: <code>Dataset</code></p>
</blockquote>
<p>A class used to store Time Series data.</p>
<h2 id="Attributes">Attributes<a class="anchor-link" href="#Attributes"> </a></h2><p>ts_tensor: np.ndarray
    Numpy array of shape (n_series, n_channels, max_len)
    where n_channels = t_cols + masks.
    Left-padded time series tensor.
    This tensor is NOT sorted according to Y_df.
    If Y_df is not sorted, the order of the
    first dimension can change.
s_matrix: np.ndarray
    Numpy array of shape (n_series, n_s).
    Matrix of static variables.
meta_data: list
    List of meta data. Each element of the list is a
    numpy array of shape (lenght of the time series, 2)
    and corresponds to unique_id, ds.
n_series: int
    Number of time series.
len_series: list
    List of length of each time series.
max_len: int
    Length of the longest time series.
n_x: int
    Number of exogenous time series
    (exogenous variables).
n_s: int
    Number of static variables.
n_channels: int
    Number of temporal variables (including target
    and mask variables).
frequency: str
    Infered frequency using pd.infer_freq
    over the ds column from the DataFrame.
t_cols: list
    List of temporal variables (mask variables included).
f_cols: list
    List of exogenous variables of the future.
s_cols:
    List of static variables.
f_idxs: list
    List of idxs of the exogenous
    variables of the future.</p>
<h2 id="Methods">Methods<a class="anchor-link" href="#Methods"> </a></h2><p>get_filtered_ts_tensor(output_size,
                       window_sampling_limit,
                       ts_idxs)
    Gets ts tensor filtered based on output_size, window_sampling_limit and
    ts_idxs.
get_f_idxs(cols)
    Gets indexes of exogenous variables.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="TimeSeriesDataset.get_filtered_ts_tensor" class="doc_header"><code>TimeSeriesDataset.get_filtered_ts_tensor</code><a href="https://github.com/Grupo-Abraxas/nixtla/tree/master/nixtla/data/tsdataset.py#L306" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>TimeSeriesDataset.get_filtered_ts_tensor</code>(<strong><code>window_sampling_limit</code></strong>:<code>int</code>, <strong><code>ts_idxs</code></strong>:<code>Optional</code>[<code>Collection</code>[<code>int</code>]]=<em><code>None</code></em>, <strong><code>output_size</code></strong>:<code>int</code>=<em><code>0</code></em>)</p>
</blockquote>
<p>Filters the last window_sampling_limit observations from ts_tensor for
the time series indexed by ts_idxs. The output_size
parameter is returned as the right_padding.</p>
<h2 id="Parameters">Parameters<a class="anchor-link" href="#Parameters"> </a></h2><p>window_sampling_limit: int
    Max size of observations to consider, including output_size.
    If window_sampling_limit &gt; max_len of the time series,
    the full tensor is returned.
ts_idxs: Collection
    Indexes of time series to consider.
    Default None: returns all ts.
output_size: int
    Forecast horizon default 0.</p>
<h2 id="Returns">Returns<a class="anchor-link" href="#Returns"> </a></h2><p>Tuple of filtered tensor and right_padding size (output_size).</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="TimeSeriesDataset.get_f_idxs" class="doc_header"><code>TimeSeriesDataset.get_f_idxs</code><a href="https://github.com/Grupo-Abraxas/nixtla/tree/master/nixtla/data/tsdataset.py#L340" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>TimeSeriesDataset.get_f_idxs</code>(<strong><code>cols</code></strong>:<code>List</code>[<code>str</code>])</p>
</blockquote>
<p>Gets indexes of exogenous variables.</p>
<h2 id="Parameters">Parameters<a class="anchor-link" href="#Parameters"> </a></h2><p>cols: List[str]
    Interest exogenous variables.</p>
<h2 id="Returns">Returns<a class="anchor-link" href="#Returns"> </a></h2><p>Indexes of cols variables.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_default_mask_df" class="doc_header"><code>get_default_mask_df</code><a href="https://github.com/Grupo-Abraxas/nixtla/tree/master/nixtla/data/tsdataset.py#L364" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_default_mask_df</code>(<strong><code>Y_df</code></strong>:<code>DataFrame</code>, <strong><code>ds_in_test</code></strong>:<code>int</code>, <strong><code>is_test</code></strong>:<code>bool</code>)</p>
</blockquote>
<p>Constructs default mask df.</p>
<h2 id="Parameters">Parameters<a class="anchor-link" href="#Parameters"> </a></h2><p>Y_df: pd.DataFrame
    Target time series with columns ['unique_id', 'ds', 'y'].
ds_in_test: int
    Numer of datestamps to use as outsample.
is_test: bool
    Wheter target time series belongs to test set.</p>
<h2 id="Returns">Returns<a class="anchor-link" href="#Returns"> </a></h2><p>Mask DataFrame with columns
['unique_id', 'ds', 'available_mask', 'sample_mask'].</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">test_default_mask</span><span class="p">(</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">ds_in_test</span><span class="p">,</span> <span class="n">is_test</span><span class="p">):</span>
    <span class="n">mask_df</span> <span class="o">=</span> <span class="n">get_default_mask_df</span><span class="p">(</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">ds_in_test</span><span class="p">,</span> <span class="n">is_test</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">Y_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">mask_df</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="s1">&#39;Unmatching index bewteen Y_df and mask_df&#39;</span>
    
    <span class="k">for</span> <span class="n">uid</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">mask_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;unique_id&#39;</span><span class="p">):</span>
        <span class="n">len_ts</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">expected_sample_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">len_ts</span><span class="p">)</span>
        <span class="n">expected_sample_mask</span><span class="p">[</span><span class="o">-</span><span class="n">ds_in_test</span><span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">is_test</span><span class="p">:</span> 
            <span class="n">expected_sample_mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">expected_sample_mask</span>
        <span class="n">expected_available_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">len_ts</span><span class="p">)</span>
        
        <span class="n">sample_mask</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sample_mask&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">available_mask</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;available_mask&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">sample_mask</span><span class="p">,</span> <span class="n">expected_sample_mask</span><span class="p">),</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;Error for sample mask for time series </span><span class="si">{</span><span class="n">uid</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">)</span>
        
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">available_mask</span><span class="p">,</span> <span class="n">expected_available_mask</span><span class="p">),</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;Error for available mask for time series </span><span class="si">{</span><span class="n">uid</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Test-for-synthtetic-time-series-data">Test for synthtetic time series data<a class="anchor-link" href="#Test-for-synthtetic-time-series-data"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">nixtla.data.utils</span> <span class="kn">import</span> <span class="n">create_synthetic_tsdata</span>

<span class="n">Y_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">S_df</span> <span class="o">=</span> <span class="n">create_synthetic_tsdata</span><span class="p">()</span>
<span class="n">ds_in_test</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">is_test</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">test_default_mask</span><span class="p">(</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">ds_in_test</span><span class="p">,</span> <span class="n">is_test</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Example-and-test-for-datasets-with-two-time-series">Example and test for datasets with two time series<a class="anchor-link" href="#Example-and-test-for-datasets-with-two-time-series"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">nixtla.data.datasets.epf</span> <span class="kn">import</span> <span class="n">EPF</span><span class="p">,</span> <span class="n">EPFInfo</span>

<span class="n">Y_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">S_df</span> <span class="o">=</span> <span class="n">EPF</span><span class="o">.</span><span class="n">load_groups</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="s1">&#39;./data&#39;</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;NP&#39;</span><span class="p">,</span> <span class="s1">&#39;PJM&#39;</span><span class="p">])</span>
<span class="n">test_default_mask</span><span class="p">(</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">ds_in_test</span><span class="o">=</span><span class="mi">728</span> <span class="o">*</span> <span class="mi">24</span><span class="p">,</span> <span class="n">is_test</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">mask_df</span> <span class="o">=</span> <span class="n">get_default_mask_df</span><span class="p">(</span><span class="n">Y_df</span><span class="o">=</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">ds_in_test</span><span class="o">=</span><span class="mi">728</span> <span class="o">*</span> <span class="mi">24</span><span class="p">,</span> <span class="n">is_test</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mask_df</span><span class="o">.</span><span class="n">sample_mask</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[&lt;matplotlib.lines.Line2D at 0x7f9c771de510&gt;]</pre>
</div>

</div>

<div class="output_area">



<div class="output_png output_subarea ">
<img src="data:image/png;base64,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
"
>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Test-for-datasets-with-more-than-two-time-series">Test for datasets with more than two time series<a class="anchor-link" href="#Test-for-datasets-with-more-than-two-time-series"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">nixtla.data.datasets.tourism</span> <span class="kn">import</span> <span class="n">Tourism</span><span class="p">,</span> <span class="n">TourismInfo</span>

<span class="n">meta</span> <span class="o">=</span> <span class="n">TourismInfo</span><span class="p">[</span><span class="s1">&#39;Yearly&#39;</span><span class="p">]</span>
<span class="n">Y_df</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">Tourism</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">meta</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="n">test_default_mask</span><span class="p">(</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">ds_in_test</span><span class="o">=</span><span class="n">meta</span><span class="o">.</span><span class="n">horizon</span><span class="p">,</span> <span class="n">is_test</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">test_default_mask</span><span class="p">(</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">ds_in_test</span><span class="o">=</span><span class="n">meta</span><span class="o">.</span><span class="n">horizon</span><span class="p">,</span> <span class="n">is_test</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Dataset-tests">Dataset tests<a class="anchor-link" href="#Dataset-tests"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">instantiate_dataset</span><span class="p">(</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">S_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">f_cols</span><span class="p">,</span> <span class="n">ds_in_test</span><span class="p">,</span> <span class="n">is_test</span><span class="p">):</span>
    <span class="n">mask_df</span> <span class="o">=</span> <span class="n">get_default_mask_df</span><span class="p">(</span><span class="n">Y_df</span><span class="o">=</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">ds_in_test</span><span class="o">=</span><span class="n">ds_in_test</span><span class="p">,</span> <span class="n">is_test</span><span class="o">=</span><span class="n">is_test</span><span class="p">)</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">TimeSeriesDataset</span><span class="p">(</span><span class="n">Y_df</span><span class="o">=</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">S_df</span><span class="o">=</span><span class="n">S_df</span><span class="p">,</span> <span class="n">X_df</span><span class="o">=</span><span class="n">X_df</span><span class="p">,</span> <span class="n">f_cols</span><span class="o">=</span><span class="n">f_cols</span><span class="p">,</span> <span class="n">mask_df</span><span class="o">=</span><span class="n">mask_df</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">mask_df</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">test_dataset_attrs</span><span class="p">(</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">S_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">f_cols</span><span class="p">,</span> <span class="n">ds_in_test</span><span class="p">,</span> <span class="n">is_test</span><span class="p">):</span>
    <span class="c1"># This set catches mistmaches between Y_df and ts_tensor</span>
    <span class="n">dataset</span><span class="p">,</span> <span class="n">mask_df</span> <span class="o">=</span> <span class="n">instantiate_dataset</span><span class="p">(</span><span class="n">Y_df</span><span class="o">=</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">S_df</span><span class="o">=</span><span class="n">S_df</span><span class="p">,</span> <span class="n">X_df</span><span class="o">=</span><span class="n">X_df</span><span class="p">,</span> 
                                           <span class="n">f_cols</span><span class="o">=</span><span class="n">f_cols</span><span class="p">,</span> <span class="n">ds_in_test</span><span class="o">=</span><span class="n">ds_in_test</span><span class="p">,</span> 
                                           <span class="n">is_test</span><span class="o">=</span><span class="n">is_test</span><span class="p">)</span>
    
    <span class="n">dfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">mask_df</span><span class="p">]</span>
    <span class="n">dfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;unique_id&#39;</span><span class="p">,</span> <span class="s1">&#39;ds&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">dfs</span><span class="p">]</span>
    <span class="n">dfs</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dfs</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    
    <span class="c1">#Temporal variables</span>
    <span class="k">for</span> <span class="n">idx_ts</span><span class="p">,</span> <span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dfs</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;unique_id&#39;</span><span class="p">)):</span>
        <span class="n">len_ts</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">len_series</span><span class="p">[</span><span class="n">idx_ts</span><span class="p">]</span>
        
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">t_cols</span><span class="p">:</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">idx_tensor</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">t_cols</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
            <span class="n">ts_tensor</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">ts_tensor</span><span class="p">[</span><span class="n">idx_ts</span><span class="p">,</span> <span class="n">idx_tensor</span><span class="p">,</span> <span class="o">-</span><span class="n">len_ts</span><span class="p">:]</span>
            
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">ts_tensor</span><span class="p">),</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Error with time series </span><span class="si">{</span><span class="n">uid</span><span class="si">}</span><span class="s1"> and col </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1"> (idx=</span><span class="si">{</span><span class="n">idx_ts</span><span class="si">}</span><span class="s1">).&#39;</span>
            <span class="p">)</span>
            
    <span class="c1">#Static variables</span>
    <span class="k">for</span> <span class="n">idx_ts</span><span class="p">,</span> <span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">S_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;unique_id&#39;</span><span class="p">)):</span>
        <span class="n">len_ts</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">len_series</span><span class="p">[</span><span class="n">idx_ts</span><span class="p">]</span>
        
        <span class="n">s</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">dataset</span><span class="o">.</span><span class="n">s_cols</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">s_matrix</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">s_matrix</span><span class="p">[[</span><span class="n">idx_ts</span><span class="p">]]</span>

        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">s_matrix</span><span class="p">),</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;Error with static variables for time series </span><span class="si">{</span><span class="n">uid</span><span class="si">}</span><span class="s1"> (idx=</span><span class="si">{</span><span class="n">idx_ts</span><span class="si">}</span><span class="s1">)&#39;</span>
        <span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">test_get_f_idxs</span><span class="p">(</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">S_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">f_cols</span><span class="p">,</span> <span class="n">ds_in_test</span><span class="p">,</span> <span class="n">is_test</span><span class="p">,</span> <span class="n">expected_f_idxs</span><span class="p">):</span>
    <span class="n">dataset</span><span class="p">,</span> <span class="n">mask_df</span> <span class="o">=</span> <span class="n">instantiate_dataset</span><span class="p">(</span><span class="n">Y_df</span><span class="o">=</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">S_df</span><span class="o">=</span><span class="n">S_df</span><span class="p">,</span> <span class="n">X_df</span><span class="o">=</span><span class="n">X_df</span><span class="p">,</span> 
                                           <span class="n">f_cols</span><span class="o">=</span><span class="n">f_cols</span><span class="p">,</span> <span class="n">ds_in_test</span><span class="o">=</span><span class="n">ds_in_test</span><span class="p">,</span> 
                                           <span class="n">is_test</span><span class="o">=</span><span class="n">is_test</span><span class="p">)</span>
    
    <span class="k">assert</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get_f_idxs</span><span class="p">(</span><span class="n">f_cols</span><span class="p">)</span> <span class="o">==</span> <span class="n">expected_f_idxs</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">test_get_filtered_ts_tensor</span><span class="p">(</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">S_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">f_cols</span><span class="p">,</span> <span class="n">ds_in_test</span><span class="p">,</span> <span class="n">is_test</span><span class="p">,</span> 
                                <span class="n">window_samplig_limit</span><span class="p">,</span> <span class="n">ts_idxs</span><span class="p">,</span> <span class="n">output_size</span><span class="p">):</span>
    <span class="n">dataset</span><span class="p">,</span> <span class="n">mask_df</span> <span class="o">=</span> <span class="n">instantiate_dataset</span><span class="p">(</span><span class="n">Y_df</span><span class="o">=</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">S_df</span><span class="o">=</span><span class="n">S_df</span><span class="p">,</span> <span class="n">X_df</span><span class="o">=</span><span class="n">X_df</span><span class="p">,</span> 
                                           <span class="n">f_cols</span><span class="o">=</span><span class="n">f_cols</span><span class="p">,</span> <span class="n">ds_in_test</span><span class="o">=</span><span class="n">ds_in_test</span><span class="p">,</span> 
                                           <span class="n">is_test</span><span class="o">=</span><span class="n">is_test</span><span class="p">)</span>
    
    <span class="n">min_len</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">len_series</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">window_samplig_limit</span> <span class="o">&gt;</span> <span class="n">min_len</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;This test only works for window_sampling_limit &#39;</span>
                        <span class="s1">&#39;lower than the size of the shortest time series.&#39;</span><span class="p">)</span>
    
    <span class="n">dfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">mask_df</span><span class="p">]</span>
    <span class="n">dfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;unique_id&#39;</span><span class="p">,</span> <span class="s1">&#39;ds&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">dfs</span><span class="p">]</span>
    <span class="n">dfs</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dfs</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="n">dfs</span> <span class="o">=</span> <span class="n">dfs</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;unique_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="n">window_samplig_limit</span><span class="p">)</span>
    <span class="c1"># This process only works for balanced datasets.</span>

    <span class="n">n_ts</span> <span class="o">=</span> <span class="n">Y_df</span><span class="p">[</span><span class="s1">&#39;unique_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n_x</span> <span class="o">=</span> <span class="n">dfs</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">wsl</span> <span class="o">=</span> <span class="n">window_samplig_limit</span>
    <span class="n">idxs</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_ts</span><span class="p">)</span> <span class="k">if</span> <span class="n">ts_idxs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ts_idxs</span>

    <span class="n">e_filtered_tensor</span> <span class="o">=</span> <span class="n">dfs</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">n_ts</span><span class="p">,</span> <span class="n">wsl</span><span class="p">,</span> <span class="n">n_x</span><span class="p">))[</span><span class="n">idxs</span><span class="p">]</span>
    <span class="n">e_filtered_tensor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">e_filtered_tensor</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">filtered_tensor</span><span class="p">,</span> <span class="n">rp</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get_filtered_ts_tensor</span><span class="p">(</span><span class="n">window_samplig_limit</span><span class="p">,</span> <span class="n">ts_idxs</span><span class="p">,</span> <span class="n">output_size</span><span class="p">)</span>
    
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">e_filtered_tensor</span><span class="p">,</span> <span class="n">filtered_tensor</span><span class="p">),</span> <span class="p">(</span>
        <span class="s2">&quot;Expected and dataset filtered_tensor are different. Check.&quot;</span>
    <span class="p">)</span>
    
    <span class="k">assert</span> <span class="n">output_size</span> <span class="o">==</span> <span class="n">rp</span><span class="p">,</span> <span class="s1">&#39;Output size and right padding are different. Check.&#39;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Test-for-not-sorted-datasets">Test for not sorted datasets<a class="anchor-link" href="#Test-for-not-sorted-datasets"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">nixtla.data.utils</span> <span class="kn">import</span> <span class="n">create_synthetic_tsdata</span>

<span class="n">Y_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">S_df</span> <span class="o">=</span> <span class="n">create_synthetic_tsdata</span><span class="p">()</span>
<span class="n">ds_in_test</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">is_test</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">f_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;future_1&#39;</span><span class="p">]</span>
<span class="n">expected_f_idxs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_dataset_attrs</span><span class="p">(</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">S_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">f_cols</span><span class="o">=</span><span class="n">f_cols</span><span class="p">,</span> <span class="n">ds_in_test</span><span class="o">=</span><span class="n">ds_in_test</span><span class="p">,</span> <span class="n">is_test</span><span class="o">=</span><span class="n">is_test</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_get_f_idxs</span><span class="p">(</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">S_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">f_cols</span><span class="o">=</span><span class="n">f_cols</span><span class="p">,</span> <span class="n">ds_in_test</span><span class="o">=</span><span class="n">ds_in_test</span><span class="p">,</span> <span class="n">is_test</span><span class="o">=</span><span class="n">is_test</span><span class="p">,</span> 
                <span class="n">expected_f_idxs</span><span class="o">=</span><span class="n">expected_f_idxs</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Expected-error-for-non-sorted-datasets">Expected error for non-sorted datasets<a class="anchor-link" href="#Expected-error-for-non-sorted-datasets"> </a></h4><p>For the <code>ts_tensor</code> attribute from the <code>dataset</code> and <code>Y_df</code> to have the same order it is necessary that <code>Y_df</code> is sorted by <code>unique_id</code> and <code>ds</code>. This test (expected error) proves that for unordered data the order is different.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">_fail_non_sorted</span><span class="p">():</span> 
    <span class="n">test_get_filtered_ts_tensor</span><span class="p">(</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">S_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">f_cols</span><span class="o">=</span><span class="n">f_cols</span><span class="p">,</span> 
                                <span class="n">ds_in_test</span><span class="o">=</span><span class="n">ds_in_test</span><span class="p">,</span> 
                                <span class="n">is_test</span><span class="o">=</span><span class="n">is_test</span><span class="p">,</span>
                                <span class="n">window_samplig_limit</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                                <span class="n">ts_idxs</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> 
                                <span class="n">output_size</span><span class="o">=</span><span class="n">ds_in_test</span><span class="p">)</span>
<span class="n">test_fail</span><span class="p">(</span><span class="n">_fail_non_sorted</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Test-for-already-sorted-datasets">Test for already sorted datasets<a class="anchor-link" href="#Test-for-already-sorted-datasets"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">nixtla.data.datasets.epf</span> <span class="kn">import</span> <span class="n">EPF</span><span class="p">,</span> <span class="n">EPFInfo</span>

<span class="n">Y_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">S_df</span> <span class="o">=</span> <span class="n">EPF</span><span class="o">.</span><span class="n">load_groups</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="s1">&#39;./data&#39;</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;NP&#39;</span><span class="p">,</span> <span class="s1">&#39;PJM&#39;</span><span class="p">])</span>
<span class="n">f_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Exogenous1&#39;</span><span class="p">,</span> <span class="s1">&#39;Exogenous2&#39;</span><span class="p">]</span>
<span class="n">ds_in_test</span> <span class="o">=</span> <span class="mi">728</span> <span class="o">*</span> <span class="mi">24</span>
<span class="n">is_test</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">expected_f_idxs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="c1">#after y column</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_dataset_attrs</span><span class="p">(</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">S_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">f_cols</span><span class="o">=</span><span class="n">f_cols</span><span class="p">,</span> <span class="n">ds_in_test</span><span class="o">=</span><span class="n">ds_in_test</span><span class="p">,</span> <span class="n">is_test</span><span class="o">=</span><span class="n">is_test</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_get_filtered_ts_tensor</span><span class="p">(</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">S_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">f_cols</span><span class="o">=</span><span class="n">f_cols</span><span class="p">,</span> <span class="n">ds_in_test</span><span class="o">=</span><span class="n">ds_in_test</span><span class="p">,</span> <span class="n">is_test</span><span class="o">=</span><span class="n">is_test</span><span class="p">,</span>
                            <span class="n">window_samplig_limit</span><span class="o">=</span><span class="mi">2_000</span><span class="p">,</span> <span class="n">ts_idxs</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> 
                            <span class="n">output_size</span><span class="o">=</span><span class="n">ds_in_test</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_get_f_idxs</span><span class="p">(</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">S_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">f_cols</span><span class="o">=</span><span class="n">f_cols</span><span class="p">,</span> <span class="n">ds_in_test</span><span class="o">=</span><span class="n">ds_in_test</span><span class="p">,</span> <span class="n">is_test</span><span class="o">=</span><span class="n">is_test</span><span class="p">,</span> 
                <span class="n">expected_f_idxs</span><span class="o">=</span><span class="n">expected_f_idxs</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Test-for-datasets-with-more-than-two-time-series">Test for datasets with more than two time series<a class="anchor-link" href="#Test-for-datasets-with-more-than-two-time-series"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">nixtla.data.datasets.tourism</span> <span class="kn">import</span> <span class="n">Tourism</span><span class="p">,</span> <span class="n">TourismInfo</span>

<span class="n">meta</span> <span class="o">=</span> <span class="n">TourismInfo</span><span class="p">[</span><span class="s1">&#39;Yearly&#39;</span><span class="p">]</span>
<span class="n">df</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">Tourism</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="s1">&#39;./data&#39;</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">meta</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;day_of_week&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ds&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">day_of_week</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;id_ts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;unique_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">codes</span>

<span class="n">Y_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">items</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;unique_id&#39;</span><span class="p">,</span> <span class="s1">&#39;ds&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">])</span>
<span class="n">X_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">items</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;unique_id&#39;</span><span class="p">,</span> <span class="s1">&#39;ds&#39;</span><span class="p">,</span> <span class="s1">&#39;day_of_week&#39;</span><span class="p">])</span>
<span class="n">S_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">items</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;unique_id&#39;</span><span class="p">,</span> <span class="s1">&#39;id_ts&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_dataset_attrs</span><span class="p">(</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">S_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">f_cols</span><span class="o">=</span><span class="p">[],</span> <span class="n">ds_in_test</span><span class="o">=</span><span class="n">meta</span><span class="o">.</span><span class="n">horizon</span><span class="p">,</span> <span class="n">is_test</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_get_filtered_ts_tensor</span><span class="p">(</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">S_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">f_cols</span><span class="o">=</span><span class="p">[],</span> <span class="n">ds_in_test</span><span class="o">=</span><span class="n">meta</span><span class="o">.</span><span class="n">horizon</span><span class="p">,</span> <span class="n">is_test</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">window_samplig_limit</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">ts_idxs</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">],</span> <span class="n">output_size</span><span class="o">=</span><span class="n">meta</span><span class="o">.</span><span class="n">horizon</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_get_f_idxs</span><span class="p">(</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">S_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">f_cols</span><span class="o">=</span><span class="p">[],</span> <span class="n">ds_in_test</span><span class="o">=</span><span class="n">ds_in_test</span><span class="p">,</span> <span class="n">is_test</span><span class="o">=</span><span class="n">is_test</span><span class="p">,</span> 
                <span class="n">expected_f_idxs</span><span class="o">=</span><span class="p">[])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

