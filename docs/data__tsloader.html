---

title: TimeSeriesLoader


keywords: fastai
sidebar: home_sidebar

summary: "Data Loader for Time Series data"
description: "Data Loader for Time Series data"
nb_path: "nbs/data__tsloader.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/data__tsloader.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="TimeSeriesLoader" class="doc_header"><code>class</code> <code>TimeSeriesLoader</code><a href="https://github.com/Grupo-Abraxas/nixtla/tree/master/nixtla/data/tsloader.py#L21" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>TimeSeriesLoader</code>(<strong><code>ts_dataset</code></strong>:<a href="/nixtla/data__tsdataset.html#TimeSeriesDataset"><code>TimeSeriesDataset</code></a>, <strong><code>model</code></strong>:<code>Literal</code>[<code>nbeats</code>, <code>esrnn</code>], <strong><code>window_sampling_limit</code></strong>:<code>int</code>, <strong><code>input_size</code></strong>:<code>int</code>, <strong><code>output_size</code></strong>:<code>int</code>, <strong><code>idx_to_sample_freq</code></strong>:<code>int</code>, <strong><code>batch_size</code></strong>:<code>int</code>, <strong><code>complete_inputs</code></strong>:<code>bool</code>, <strong><code>shuffle</code></strong>:<code>bool</code>, <strong><code>len_sample_chunks</code></strong>:<code>Optional</code>[<code>int</code>]=<em><code>None</code></em>, <strong><code>n_series_per_batch</code></strong>:<code>Optional</code>[<code>int</code>]=<em><code>None</code></em>, <strong><code>verbose</code></strong>:<code>bool</code>=<em><code>False</code></em>)</p>
</blockquote>
<p>DataLoader for Time Series data.</p>
<h2 id="Attributes">Attributes<a class="anchor-link" href="#Attributes"> </a></h2><p>ts_dataset: TimeSeriesDataset
    Object of class TimeSeriesDataset.
t_cols: list
    List of temporal variables (mask variables included).
f_cols: list
    List of exogenous variables of the future.
model: str
    Model to be used.
    One of ['nbeats', 'esrnn'].
window_sampling_limit: int
    Max size of observations to consider, including output_size.
input_size: int
    Size of the training sets.
output_size: int
    Forecast horizon.
idx_to_sample_freq: int
    Step size to construct windows.
    Ej. if idx_to_sample_freq=7, each 7 timestamps
    a window will be constructed.
batch_size: int
    Number of samples considered in each iteration.
complete_inputs: bool
    Whether consider only windows of length equals to input_size.
shuffle: bool
    Shuffled batch.
    If False, batch size will be ignored and
    all windows will be used when training.
len_sample_chunks: Optional[int] = None
    Size of complete windows.
    Only used for model = 'esrnn'!
    Default None, equls to input_size + ouput_size.
n_series_per_batch: Optional[int] = None
    Number of time series per batch.
verbose: bool = False
    Whether display informative messages.
windows_size: int
    Size of the windows.
    For model='nbeats', window_size=input_size + output_size.
    For model='esrnn', window_size=len_sample_chunks.
padding: Tuple[int, int]
    Tuple of left and right sizes of the padding.
    Used to pad the ts_tensor with 0.
    For model='nbeats', padding=(input_size, output_size).
    For model='esrnn', padding=(0, 0).
sampleable_ts_idxs: np.ndarray
    Indexes of sampleable time series.
n_sampleable_ts_idxs: int
    Number of sampleable time series.
n_batches:
    Number of batches given conditions.</p>
<h2 id="Methods">Methods<a class="anchor-link" href="#Methods"> </a></h2><p>get_n_variables()
    Returns Tuple of number of exogenous and static variables.
get_n_series()
    Returns number of time series.
get_max_len()
    Returns max length of the time series.
get_n_channels()
    Returns number of channels.
get_frequency()
    Returns infered frequency.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="TimeSeriesLoader.__getitem__" class="doc_header"><code>TimeSeriesLoader.__getitem__</code><a href="https://github.com/Grupo-Abraxas/nixtla/tree/master/nixtla/data/tsloader.py#L372" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>TimeSeriesLoader.__getitem__</code>(<strong><code>index</code></strong>:<code>Union</code>[<code>Collection</code>[<code>int</code>], <code>ndarray</code>])</p>
</blockquote>
<p>Gets batch based on index.</p>
<h2 id="Parameters">Parameters<a class="anchor-link" href="#Parameters"> </a></h2><p>index: Collection[int]
    Indexes of time series to consider.</p>
<h2 id="Returns">Returns<a class="anchor-link" href="#Returns"> </a></h2><p>Batch corresponding to index.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="TimeSeriesLoader.__iter__" class="doc_header"><code>TimeSeriesLoader.__iter__</code><a href="https://github.com/Grupo-Abraxas/nixtla/tree/master/nixtla/data/tsloader.py#L390" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>TimeSeriesLoader.__iter__</code>()</p>
</blockquote>
<p>Batch iterator.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="TimeSeriesLoader.get_n_variables" class="doc_header"><code>TimeSeriesLoader.get_n_variables</code><a href="https://github.com/Grupo-Abraxas/nixtla/tree/master/nixtla/data/tsloader.py#L409" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>TimeSeriesLoader.get_n_variables</code>()</p>
</blockquote>
<p>Gets number of exogenous and static variables.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="TimeSeriesLoader.get_n_series" class="doc_header"><code>TimeSeriesLoader.get_n_series</code><a href="https://github.com/Grupo-Abraxas/nixtla/tree/master/nixtla/data/tsloader.py#L414" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>TimeSeriesLoader.get_n_series</code>()</p>
</blockquote>
<p>Gets number of time series.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="TimeSeriesLoader.get_max_len" class="doc_header"><code>TimeSeriesLoader.get_max_len</code><a href="https://github.com/Grupo-Abraxas/nixtla/tree/master/nixtla/data/tsloader.py#L419" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>TimeSeriesLoader.get_max_len</code>()</p>
</blockquote>
<p>Gets max len of time series.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="TimeSeriesLoader.get_n_channels" class="doc_header"><code>TimeSeriesLoader.get_n_channels</code><a href="https://github.com/Grupo-Abraxas/nixtla/tree/master/nixtla/data/tsloader.py#L424" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>TimeSeriesLoader.get_n_channels</code>()</p>
</blockquote>
<p>Gets number of channels considered.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="TimeSeriesLoader.get_frequency" class="doc_header"><code>TimeSeriesLoader.get_frequency</code><a href="https://github.com/Grupo-Abraxas/nixtla/tree/master/nixtla/data/tsloader.py#L429" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>TimeSeriesLoader.get_frequency</code>()</p>
</blockquote>
<p>Gets infered frequency.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Test-for-TimeSeriesLoader's-methods">Test for TimeSeriesLoader's methods<a class="anchor-link" href="#Test-for-TimeSeriesLoader's-methods"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Sampleable-ts-idxs">Sampleable ts idxs<a class="anchor-link" href="#Sampleable-ts-idxs"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">nixtla.data.utils</span> <span class="kn">import</span> <span class="n">create_synthetic_tsdata</span>

<span class="n">n_ts</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">Y_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">S_df</span> <span class="o">=</span> <span class="n">create_synthetic_tsdata</span><span class="p">(</span><span class="n">n_ts</span><span class="o">=</span><span class="n">n_ts</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ds_in_test</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">is_test</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">len_sample_chunks</span> <span class="o">=</span> <span class="mi">20</span> <span class="c1">#only for ESRNN</span>

<span class="n">dataset</span> <span class="o">=</span> <span class="n">TimeSeriesDataset</span><span class="p">(</span><span class="n">Y_df</span><span class="o">=</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">X_df</span><span class="o">=</span><span class="n">X_df</span><span class="p">,</span> <span class="n">S_df</span><span class="o">=</span><span class="n">S_df</span><span class="p">,</span>
                            <span class="n">ds_in_test</span><span class="o">=</span><span class="n">ds_in_test</span><span class="p">,</span> 
                            <span class="n">is_test</span><span class="o">=</span><span class="n">is_test</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">test_sampleable_ts</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">input_size</span><span class="p">,</span> <span class="n">output_size</span><span class="p">,</span> 
                       <span class="n">len_sample_chunks</span><span class="p">,</span>
                       <span class="n">complete_inputs</span><span class="p">,</span> <span class="n">ds_in_test</span><span class="p">):</span>
    <span class="n">loader</span> <span class="o">=</span> <span class="n">TimeSeriesLoader</span><span class="p">(</span><span class="n">ts_dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
                              <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                              <span class="n">window_sampling_limit</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">max_len</span><span class="p">,</span>
                              <span class="n">input_size</span><span class="o">=</span><span class="n">input_size</span><span class="p">,</span>
                              <span class="n">output_size</span><span class="o">=</span><span class="n">output_size</span><span class="p">,</span>
                              <span class="n">idx_to_sample_freq</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                              <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                              <span class="n">complete_inputs</span><span class="o">=</span><span class="n">complete_inputs</span><span class="p">,</span>
                              <span class="n">len_sample_chunks</span><span class="o">=</span><span class="n">len_sample_chunks</span><span class="p">,</span>
                              <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="n">sizes</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">len_series</span>
    <span class="k">if</span> <span class="n">complete_inputs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">model</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;esrnn&#39;</span><span class="p">]:</span>
            <span class="n">min_size</span> <span class="o">=</span> <span class="n">len_sample_chunks</span> <span class="ow">or</span> <span class="n">input_size</span> <span class="o">+</span> <span class="n">output_size</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">min_size</span> <span class="o">=</span> <span class="n">input_size</span> <span class="o">+</span> <span class="n">output_size</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">min_size</span> <span class="o">=</span> <span class="n">output_size</span>
    <span class="n">e_sampleable_ts_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sizes</span> <span class="o">&gt;</span> <span class="n">min_size</span> <span class="o">+</span> <span class="n">ds_in_test</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">loader</span><span class="o">.</span><span class="n">sampleable_ts_idxs</span><span class="p">,</span> <span class="n">e_sampleable_ts_idxs</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_sampleable_ts</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="s1">&#39;esrnn&#39;</span><span class="p">,</span> <span class="n">input_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">output_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                   <span class="n">len_sample_chunks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">complete_inputs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                   <span class="n">ds_in_test</span><span class="o">=</span><span class="n">ds_in_test</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_sampleable_ts</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="s1">&#39;esrnn&#39;</span><span class="p">,</span> <span class="n">input_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">output_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                   <span class="n">len_sample_chunks</span><span class="o">=</span><span class="n">len_sample_chunks</span><span class="p">,</span> <span class="n">complete_inputs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                   <span class="n">ds_in_test</span><span class="o">=</span><span class="n">ds_in_test</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_sampleable_ts</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="s1">&#39;nbeats&#39;</span><span class="p">,</span> <span class="n">input_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">output_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                   <span class="n">len_sample_chunks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">complete_inputs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                   <span class="n">ds_in_test</span><span class="o">=</span><span class="n">ds_in_test</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_sampleable_ts</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="s1">&#39;nbeats&#39;</span><span class="p">,</span> <span class="n">input_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">output_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                   <span class="n">len_sample_chunks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">complete_inputs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                   <span class="n">ds_in_test</span><span class="o">=</span><span class="n">ds_in_test</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The following test checks failure for not sampleable time series.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">_fail_not_sampleable_ts</span><span class="p">():</span> <span class="k">return</span> <span class="n">loader</span><span class="p">[[</span><span class="mi">1</span><span class="p">]]</span>
<span class="n">test_fail</span><span class="p">(</span><span class="n">_fail_not_sampleable_ts</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Batches-size">Batches size<a class="anchor-link" href="#Batches-size"> </a></h3><p>Tests for <code>__iter__</code> method.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The following test checks the correct size of batches. Note that the data loader only returns batches of <code>batch_size</code> when suffle is True.
For <code>nbeats</code> the windows size should be <code>input_size + output_size</code>. Meanwhile for <code>esrnn</code> the windows size should be <code>len_sample_chunks</code>. When <code>len_sample_chunks=None</code> then <code>len_sample_chunks=input_size + output_size</code>.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">nixtla.data.utils</span> <span class="kn">import</span> <span class="n">create_synthetic_tsdata</span>

<span class="n">n_ts</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">Y_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">S_df</span> <span class="o">=</span> <span class="n">create_synthetic_tsdata</span><span class="p">(</span><span class="n">n_ts</span><span class="o">=</span><span class="n">n_ts</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ds_in_test</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">is_test</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">len_sample_chunks</span> <span class="o">=</span> <span class="mi">20</span> <span class="c1">#only for ESRNN</span>

<span class="n">dataset</span> <span class="o">=</span> <span class="n">TimeSeriesDataset</span><span class="p">(</span><span class="n">Y_df</span><span class="o">=</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">X_df</span><span class="o">=</span><span class="n">X_df</span><span class="p">,</span> <span class="n">S_df</span><span class="o">=</span><span class="n">S_df</span><span class="p">,</span>
                            <span class="n">ds_in_test</span><span class="o">=</span><span class="n">ds_in_test</span><span class="p">,</span> 
                            <span class="n">is_test</span><span class="o">=</span><span class="n">is_test</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">test_batch_size</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">input_size</span><span class="p">,</span> <span class="n">output_size</span><span class="p">,</span> <span class="n">len_sample_chunks</span><span class="p">,</span>
                    <span class="n">expected_window_size</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This test checks the correct size of batches.&quot;&quot;&quot;</span>
    <span class="n">loader</span> <span class="o">=</span> <span class="n">TimeSeriesLoader</span><span class="p">(</span><span class="n">ts_dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
                              <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                              <span class="n">window_sampling_limit</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">max_len</span><span class="p">,</span>
                              <span class="n">input_size</span><span class="o">=</span><span class="n">input_size</span><span class="p">,</span>
                              <span class="n">output_size</span><span class="o">=</span><span class="n">output_size</span><span class="p">,</span>
                              <span class="n">idx_to_sample_freq</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                              <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                              <span class="n">complete_inputs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">len_sample_chunks</span><span class="o">=</span><span class="n">len_sample_chunks</span><span class="p">,</span>
                              <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">loader</span><span class="p">:</span>
        <span class="n">S</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span>
        <span class="n">available_mask</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;available_mask&#39;</span><span class="p">]</span>
        <span class="n">sample_mask</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;sample_mask&#39;</span><span class="p">]</span>
        <span class="n">idxs</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;idxs&#39;</span><span class="p">]</span>

        <span class="n">test_eq</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">n_s</span><span class="p">))</span>
        <span class="n">test_eq</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">expected_window_size</span><span class="p">))</span>
        <span class="n">test_eq</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">n_x</span><span class="p">,</span> <span class="n">expected_window_size</span><span class="p">))</span>
        <span class="n">test_eq</span><span class="p">(</span><span class="n">available_mask</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">expected_window_size</span><span class="p">))</span>
        <span class="n">test_eq</span><span class="p">(</span><span class="n">sample_mask</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">expected_window_size</span><span class="p">))</span>
        <span class="n">test_eq</span><span class="p">(</span><span class="n">idxs</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="p">(</span><span class="n">batch_size</span><span class="p">,))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">test_batch_iteration</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">input_size</span><span class="p">,</span> <span class="n">output_size</span><span class="p">,</span> 
                         <span class="n">len_sample_chunks</span><span class="p">,</span> <span class="n">complete_inputs</span><span class="p">,</span>
                         <span class="n">shuffle</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This test checks proper iteration when batch_size=1.&quot;&quot;&quot;</span>
    <span class="n">loader</span> <span class="o">=</span> <span class="n">TimeSeriesLoader</span><span class="p">(</span><span class="n">ts_dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
                              <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                              <span class="n">window_sampling_limit</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">max_len</span><span class="p">,</span>
                              <span class="n">input_size</span><span class="o">=</span><span class="n">input_size</span><span class="p">,</span>
                              <span class="n">output_size</span><span class="o">=</span><span class="n">output_size</span><span class="p">,</span>
                              <span class="n">idx_to_sample_freq</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                              <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                              <span class="n">complete_inputs</span><span class="o">=</span><span class="n">complete_inputs</span><span class="p">,</span>
                              <span class="n">len_sample_chunks</span><span class="o">=</span><span class="n">len_sample_chunks</span><span class="p">,</span>
                              <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">)</span>
    
    <span class="n">batches</span> <span class="o">=</span> <span class="p">[</span><span class="n">batch</span> <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">loader</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">batches</span><span class="p">)</span> <span class="o">==</span> <span class="n">loader</span><span class="o">.</span><span class="n">n_sampleable_ts</span><span class="p">,</span> <span class="p">(</span>
        <span class="s1">&#39;Expected and actual batches are different &#39;</span>
        <span class="s1">&#39;for batch_size=1&#39;</span>
    <span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="ESRNN">ESRNN<a class="anchor-link" href="#ESRNN"> </a></h4>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">len_sample_chunks</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">test_batch_size</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="s1">&#39;esrnn&#39;</span><span class="p">,</span> <span class="n">input_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">output_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> 
                <span class="n">len_sample_chunks</span><span class="o">=</span><span class="n">len_sample_chunks</span><span class="p">,</span> 
                <span class="n">expected_window_size</span><span class="o">=</span><span class="n">len_sample_chunks</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_batch_iteration</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="s1">&#39;esrnn&#39;</span><span class="p">,</span> <span class="n">input_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">output_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                     <span class="n">len_sample_chunks</span><span class="o">=</span><span class="n">len_sample_chunks</span><span class="p">,</span>
                     <span class="n">complete_inputs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_batch_iteration</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="s1">&#39;esrnn&#39;</span><span class="p">,</span> <span class="n">input_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">output_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                     <span class="n">len_sample_chunks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">complete_inputs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_batch_iteration</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="s1">&#39;esrnn&#39;</span><span class="p">,</span> <span class="n">input_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">output_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                     <span class="n">len_sample_chunks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">complete_inputs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_batch_iteration</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="s1">&#39;esrnn&#39;</span><span class="p">,</span> <span class="n">input_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">output_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                     <span class="n">len_sample_chunks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">complete_inputs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>WARNING:root:Batch size will be ignored (shuffle=False). All constructed windows will be used to train.
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="NBEATS">NBEATS<a class="anchor-link" href="#NBEATS"> </a></h4>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">input_size</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">output_size</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">test_batch_size</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="s1">&#39;nbeats&#39;</span><span class="p">,</span> <span class="n">input_size</span><span class="o">=</span><span class="n">input_size</span><span class="p">,</span> <span class="n">output_size</span><span class="o">=</span><span class="n">output_size</span><span class="p">,</span> 
                <span class="n">len_sample_chunks</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">expected_window_size</span><span class="o">=</span><span class="n">input_size</span> <span class="o">+</span> <span class="n">output_size</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_batch_iteration</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="s1">&#39;nbeats&#39;</span><span class="p">,</span> <span class="n">input_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">output_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                     <span class="n">len_sample_chunks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">complete_inputs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_batch_iteration</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="s1">&#39;nbeats&#39;</span><span class="p">,</span> <span class="n">input_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">output_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                     <span class="n">len_sample_chunks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">complete_inputs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_batch_iteration</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="s1">&#39;nbeats&#39;</span><span class="p">,</span> <span class="n">input_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">output_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                     <span class="n">len_sample_chunks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">complete_inputs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>WARNING:root:Batch size will be ignored (shuffle=False). All constructed windows will be used to train.
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Proper-batch-construction">Proper batch construction<a class="anchor-link" href="#Proper-batch-construction"> </a></h3><p>Tests for <code>__getitem__</code> method.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">nixtla.data.utils</span> <span class="kn">import</span> <span class="n">create_synthetic_tsdata</span>

<span class="n">n_ts</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">Y_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">S_df</span> <span class="o">=</span> <span class="n">create_synthetic_tsdata</span><span class="p">(</span><span class="n">n_ts</span><span class="o">=</span><span class="n">n_ts</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ds_in_test</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">is_test</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">dataset</span> <span class="o">=</span> <span class="n">TimeSeriesDataset</span><span class="p">(</span><span class="n">Y_df</span><span class="o">=</span><span class="n">Y_df</span><span class="p">,</span> <span class="n">X_df</span><span class="o">=</span><span class="n">X_df</span><span class="p">,</span> <span class="n">S_df</span><span class="o">=</span><span class="n">S_df</span><span class="p">,</span>
                            <span class="n">ds_in_test</span><span class="o">=</span><span class="n">ds_in_test</span><span class="p">,</span> 
                            <span class="n">is_test</span><span class="o">=</span><span class="n">is_test</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">numpy.lib.stride_tricks</span> <span class="kn">import</span> <span class="n">sliding_window_view</span>

<span class="c1"># This test only works for the dataset constructed</span>
<span class="c1"># before and for the 21 time series</span>
<span class="k">def</span> <span class="nf">test_batch_construction</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">input_size</span><span class="p">,</span> <span class="n">output_size</span><span class="p">,</span> 
                            <span class="n">len_sample_chunks</span><span class="p">,</span> <span class="n">window_step</span><span class="p">,</span> 
                            <span class="n">complete_inputs</span><span class="p">,</span> <span class="n">ds_in_test</span><span class="p">):</span>
    
    <span class="n">wsl</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">max_len</span>
    
    <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;nbeats&#39;</span><span class="p">:</span>
        <span class="n">windows_size</span> <span class="o">=</span> <span class="n">input_size</span> <span class="o">+</span> <span class="n">output_size</span>
    <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;esrnn&#39;</span><span class="p">:</span>
        <span class="n">windows_size</span> <span class="o">=</span> <span class="n">len_sample_chunks</span> <span class="ow">or</span> <span class="n">input_size</span> <span class="o">+</span> <span class="n">output_size</span>

    <span class="n">loader</span> <span class="o">=</span> <span class="n">TimeSeriesLoader</span><span class="p">(</span><span class="n">ts_dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
                              <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                              <span class="n">window_sampling_limit</span><span class="o">=</span><span class="n">wsl</span><span class="p">,</span>
                              <span class="n">input_size</span><span class="o">=</span><span class="n">input_size</span><span class="p">,</span>
                              <span class="n">output_size</span><span class="o">=</span><span class="n">output_size</span><span class="p">,</span>
                              <span class="n">idx_to_sample_freq</span><span class="o">=</span><span class="n">window_step</span><span class="p">,</span>
                              <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                              <span class="n">complete_inputs</span><span class="o">=</span><span class="n">complete_inputs</span><span class="p">,</span>
                              <span class="n">len_sample_chunks</span><span class="o">=</span><span class="n">len_sample_chunks</span><span class="p">,</span>
                              <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">windows</span> <span class="o">=</span> <span class="n">loader</span><span class="p">[[</span><span class="mi">20</span><span class="p">]][</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span>
    
    <span class="c1">#Expected windows</span>
    <span class="n">uid</span> <span class="o">=</span> <span class="n">Y_df</span><span class="p">[</span><span class="s1">&#39;unique_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()[</span><span class="mi">20</span><span class="p">]</span>
    <span class="n">Y_original</span> <span class="o">=</span> <span class="n">Y_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;unique_id == @uid&#39;</span><span class="p">)[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">Y_original</span><span class="o">.</span><span class="n">size</span>
    <span class="n">Y_sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">wsl</span><span class="p">)</span>
    <span class="n">Y_sample</span><span class="p">[</span><span class="o">-</span><span class="n">size</span><span class="p">:]</span> <span class="o">=</span> <span class="n">Y_original</span>
    <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;nbeats&#39;</span><span class="p">:</span>
        <span class="n">Y_sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">Y_sample</span><span class="p">,</span> <span class="p">(</span><span class="n">input_size</span><span class="p">,</span> <span class="n">output_size</span><span class="p">))</span>
        
    <span class="n">e_windows</span> <span class="o">=</span> <span class="n">sliding_window_view</span><span class="p">(</span><span class="n">Y_sample</span><span class="p">,</span> <span class="n">window_shape</span><span class="o">=</span><span class="n">windows_size</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;nbeats&#39;</span><span class="p">:</span>
        <span class="n">e_windows</span> <span class="o">=</span> <span class="n">e_windows</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="p">(</span><span class="n">ds_in_test</span> <span class="o">+</span> <span class="n">output_size</span><span class="p">):</span><span class="n">window_step</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;esrnn&#39;</span><span class="p">:</span>
        <span class="n">e_windows</span> <span class="o">=</span> <span class="n">e_windows</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="n">ds_in_test</span><span class="p">:</span><span class="n">window_step</span><span class="p">]</span>
    <span class="c1"># This test works assuming there are no series with values of zero.</span>
    <span class="k">if</span> <span class="n">complete_inputs</span><span class="p">:</span>
        <span class="n">sampleable_windows_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">e_windows</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">windows_size</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sampleable_windows_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">e_windows</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">ds_in_test</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        
    <span class="n">e_windows</span> <span class="o">=</span> <span class="n">e_windows</span><span class="p">[</span><span class="n">sampleable_windows_idxs</span><span class="p">]</span>
    
    <span class="c1">#Comparison</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">windows</span><span class="p">,</span> <span class="n">e_windows</span><span class="p">),</span> <span class="p">(</span>
        <span class="s1">&#39;Expected and actual windows are different&#39;</span>
    <span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_batch_construction</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="s1">&#39;nbeats&#39;</span><span class="p">,</span> <span class="n">input_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">output_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> 
                        <span class="n">len_sample_chunks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">window_step</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                        <span class="n">complete_inputs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">ds_in_test</span><span class="o">=</span><span class="n">ds_in_test</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>WARNING:root:Batch size will be ignored (shuffle=False). All constructed windows will be used to train.
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_batch_construction</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="s1">&#39;esrnn&#39;</span><span class="p">,</span> <span class="n">input_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">output_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> 
                        <span class="n">len_sample_chunks</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">window_step</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                        <span class="n">complete_inputs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ds_in_test</span><span class="o">=</span><span class="n">ds_in_test</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>WARNING:root:Batch size will be ignored (shuffle=False). All constructed windows will be used to train.
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_batch_construction</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="s1">&#39;esrnn&#39;</span><span class="p">,</span> <span class="n">input_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">output_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> 
                        <span class="n">len_sample_chunks</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">window_step</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                        <span class="n">complete_inputs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ds_in_test</span><span class="o">=</span><span class="n">ds_in_test</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>WARNING:root:Batch size will be ignored (shuffle=False). All constructed windows will be used to train.
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_batch_construction</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="s1">&#39;nbeats&#39;</span><span class="p">,</span> <span class="n">input_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">output_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> 
                        <span class="n">len_sample_chunks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">window_step</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                        <span class="n">complete_inputs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">ds_in_test</span><span class="o">=</span><span class="n">ds_in_test</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>WARNING:root:Batch size will be ignored (shuffle=False). All constructed windows will be used to train.
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

